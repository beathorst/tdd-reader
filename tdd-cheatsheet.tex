\documentclass[a4paper,10pt]{scrartcl}
\include{packages}
\include{styles}

\usepackage[american]{babel}
\selectlanguage{american}

\hypersetup{
 pdfauthor={Oliver Klee, typo3-coding@oliverklee.de},
 pdftitle={Test-driven development with TYPO3 CMS},
 pdfsubject={Handout for Oliver Klee's workshops on test-driven development with TYPO3 CMS.},
 pdfkeywords={TDD, unit testing, PHPUnit, workshop, seminar, PHP}
}

\author{
  Oliver Klee, \texttt{typo3-coding@oliverklee.de}, \texttt{@oliklee} \\
  \url{https://github.com/oliverklee/tdd-reader}
}

\date{Version 1.5.0, \today, for TYPO3 CMS 6.2}

\title{
  Cheatsheet for test-driven development with TYPO3 CMS
}

\begin{document}

\maketitle

\section*{License}

This handout is licensed under a \emph{Creative Commons} license, namely under a \emph{Attribution-ShareAlike~4.0 (CC BY-SA 4.0)}. This means that you can use, edit and distribute this handout (even commercially) under the following conditions:

\begin{description}
  \item[Attribution.] You need to give credit to the author (me) by listing my name (Oliver Klee). If you also list the source\footnote{\url{https://github.com/oliverklee/tdd-reader}}, that would be nice. And if you want to make me happy, please drop me an e-mail if you use this document.
  \item[ShareAlike.] If you edit or change this document or use it as a basis for some other document, you must use the same license for the resulting document.
  \item[Name the license.] If you distribute this document, you'll need to mention or enclose the license.
\end{description} 

You can find a more comprehensive version of this license online.\footnote{\url{http://creativecommons.org/licenses/by-sa/4.0/}}


\newpage

\tableofcontents

\pagebreak

\section{File and class naming}

\subsection{File names}

\begin{tabular}{|l|l|}
  \hline
  \fett{Production code file name} & \fett{Test file name} \\
  \hline
  \texttt{Classes/Domain/Model/Shoe.php} & \texttt{Tests/Unit/Domain/Model/ShoeTest.php} \\
  \hline
  \texttt{Classes/Service/BaristaService.php} & \texttt{Tests/Unit/Service/BaristaServiceTest.php} \\
  \hline
  \texttt{pi1/class.tx\_frubble\_pi1.php} & \texttt{Tests/Unit/pi1/pi1Test.php} \\
  \hline
\end{tabular}


\subsection{Class names}

\small
\begin{tabular}{|l|l|}
  \hline
  \fett{Production code class name} & \fett{Test class name} \\
  \hline
  \texttt{OliverKlee\textbackslash Shop\textbackslash Domain\textbackslash Model\textbackslash Shoe} & \texttt{OliverKlee\textbackslash Shop\textbackslash Tests\textbackslash Unit\textbackslash Domain\textbackslash Model\textbackslash ShoeTest} \\
  \hline
  \texttt{OliverKlee\textbackslash Shop\textbackslash Service\textbackslash BaristaService} & \texttt{OliverKlee\textbackslash Shop\textbackslash Tests\textbackslash Unit\textbackslash Service\textbackslash BaristaServiceTest} \\
  \hline
  \texttt{tx\_frubble\_pi1} & \texttt{tx\_frubble\_Tests\_Unit\_pi1\_pi1Test} \\
  \hline
\end{tabular}
\normalsize

\section{Test class structure}

\subsection{Extbase extensions}

\small
\begin{phpcode}
namespace OliverKlee\Shop\Tests\Unit\Domain\Model;

use OliverKlee\Shop\Domain\Model\Article;

class ArticleTest extends \TYPO3\CMS\Core\Tests\UnitTestCase  {
  /**
   * @var Article;
   */
  protected $subject = null;

  public function setUp() {
    $this->subject = new Article;
    $this->subject->initializeObject();
  }

  /**
   * @test
   */
  public function getNameInitiallyReturnsEmptyString() {
    $this->assertSame(
      '',
      $this->subject->getName()
    );
  }

  /**
   * @test
   */
  public function setNameSetsName() {
    $this->subject->setName('foo bar');

    $this->assertSame(
      'foo bar',
      $this->subject->getName()
    );
  }

  // ...
}
\end{phpcode}
\normalsize

\subsection{Non-extbase extensions}

\small
\begin{phpcode}
// You need to require_once the class-to-test if your extension
// does not make use of ext_autoload.php.
require_once(t3lib_extMgm::extPath('oelib') . 'class.tx_oelib_Attachment.php');

class Tx_Oelib_Tests_Unit_AttachmentTest extends \Tx_Phpunit_TestCase {
  /**
   * @var \Tx_Oelib_Attachment
   */
  protected $subject = null;

  public function setUp() {
    $this->subject = new \Tx_Oelib_Attachment();
  }

  /**
   * @test
   */
  public function getFileNameInitiallyReturnsAnEmptyString() {
    $this->assertSame(
      '',
      $this->subject->getFileName()
    );
  }

  /**
   * @test
   */
  public function getFileNameWithFileNameSetReturnsFileName() {
    $this->subject->setFileName('test.txt');

    $this->assertSame(
      'test.txt',
      $this->subject->getFileName()
    );
  }

  /**
   * @test
   */
  public function setFileNameWithEmptyFileNameThrowsException() {
    $this->setExpectedException('InvalidArgumentException', '$fileName must not be empty.');

    $this->subject->setFileName('');
  }

  // ...
}
\end{phpcode}
\normalsize

\subsection{Non-TYPO3 PHP projects}

\small
\begin{phpcode}
namespace Books\Domain\Model;

$currentDirectory = dirname(__FILE__);
require_once($currentDirectory . '../../../../../Classes/Domain/Model/Book.php');

class BookTest extends \PHPUnit_Framework_TestCase {
  /**
   * @var Book
   */
  protected $subject = null;

  public function setUp() {
    $this->subject = new Book();
  }

  /**
   * @test
   */
  public function getTitleInitiallyReturnsEmptyString() {
    $this->assertSame(
      '',
      $this->subject->getTitle()
    );
  }

  /**
   * @test
   */
  public function setTitleSetsTitle() {
    $this->subject->setTitle('foo bar');

    $this->assertSame(
      'foo bar',
      $this->subject->getTitle()
    );
  }
}
\end{phpcode}
\normalsize

\section{Testing for Exceptions}

\subsection{Test for the Exception class only (recommended)}
\small
\begin{phpcode}
/**
 * @test
 * @expectedException InvalidArgumentException
 */
public function createBreadWithNegativeSizeThrowsException() {
  $this->subject->createBread(-1);
}
\end{phpcode}
\normalsize

\subsection{Test for the exception class, message and (optionally) the code (recommended)}
\small
\begin{phpcode}
/**
 * @test
 */
public function createBreadWithNegativeSizeThrowsException() {
  $this->setExpectedException(
    'InvalidArgumentException',
    '$size must be > 0.',
     1323700434
  );

  $this->subject->createBread(-1);
}

/**
 * @test
 */
public function createBreadWithZeroSizeThrowsException() {
  $this->setExpectedException(
    'InvalidArgumentException',
    '$size must be > 0.'
  );

  $this->subject->createBread(-1);
}
\end{phpcode}
\normalsize

\subsection{Try/catch (not recommended)}
\small
\begin{phpcode}
/**
 * @test
 */
public function createBreadWithNegativeSizeThrowsException() {
  try {
    $this->subject->createBread(-1);
    $this->fail('The expected exception has not been thrown.');
  } catch (InvalidArgumentException $exception) {
  }
}
\end{phpcode}
\normalsize

\newpage

\section{Testing abstract classes}

\subsection{Using the PHPUnit mock builder (recommended)}

This will create an instance of the abstract class with all abstract methods mocked.\\

\small
\begin{phpcode}
class Tx_Coffee_Domain_Model_AbstractBeverageTest {
 /**
  * @var \Tx_Coffee_Domain_Model_AbstractBeverage|\PHPUnit_Framework_MockObject_MockObject
  *
 protected $subject = null;

 protected function setUp() {
   $this->subject = $this->getMockForAbstractClass('Tx_Coffee_Domain_Model_AbstractBeverage');
 }
\end{phpcode}
\normalsize

\subsection{Creating a concrete subclass (recommended)}
This is recommended if you need to provide your subclass with some additional or specific behavior.

In \texttt{Tests/Unit/Fixtures/}, create a subclass of the abstract class:\\

\small
\begin{phpcode}
namespace OliverKlee\Coffee\Tests\Unit\Domain\Model\Fixtures;

class TestingBeverage extends \OliverKlee\Coffee\Domain\Model\AbstractBeverage {
  // ...
}
\end{phpcode}
\normalsize

Then you can use and instantiate the concrete subclass in your unit tests:\\

\begin{phpcode}
use OliverKlee\Coffee\Tests\Unit\Domain\Model\Fixtures\TestingBeverage;

class Tx_Coffee_Domain_Model_AbstractBeverageTest {
 /**
  * @var TestingBeverage
  *
 protected $subject = null;

 protected function setUp() {
   $this->subject = new TestingBeverage();
 }
\end{phpcode}

\subsection{Using eval (not recommended)}
This is not recommended as this breaks code completion in your IDE.


\newpage

\section{Using the testing framework of the PHPUnit TYPO3 extension}

\small
\begin{phpcode}
class tx_oelib_DataMapperTest extends \Tx_Phpunit_TestCase {
  /**
   * @var \Tx_Phpunit_Framework
   */
  protected $testingFramework = null;

  protected $subject = null;

  public function setUp() {
    $this->testingFramework = new Tx_Phpunit_Framework('tx_oelib');

    $this->subject = new ...;
  }

  public function tearDown() {
    $this->testingFramework->cleanUp();
  }

  /**
   * @test
   */
  public function findWithUidOfExistingRecordReturnsModelDataFromDatabase() {
    $uid = $this->testingFramework->createRecord(
      'tx_oelib_test', array('title' => 'foo')
    );

    $this->assertSame(
      'foo',
      $this->subject->find($uid)->getTitle()
    );
  }
\end{phpcode}
\normalsize

\section{Using mock file systems with vfsStream}
\subsection{Setting it all up}
\begin{phpcode}
use \org\bovigo\vfs\vfsStream;

/**
 * @var \org\bovigo\vfs\vfsStreamFile
 */
protected $moreStuff;

public function setUp() {
  // This is the same as ::register and ::setRoot.
  $root = vfsStream::setUp('Stuff');
  $this->moreStuff = vfsStream::newDirectory('moreStuff')->at($root);

  $this->subject = new ...
}
\end{phpcode}

\subsection{Using the files}
\begin{phpcode}
/**
 * @test
 */
public function checkFileWithPathOfExistingNonEmptyFileReturnsTrue() {
  $file = vfsStream::newFile('test.php')->at($this->moreStuff);
  $file->withContent('Hello world!');

  $this->assertTrue(
    $this->subject->checkFile(\vfsStream::url('Stuff/moreStuff/test.php'))
  );
}
\end{phpcode}


\section{PHPUnit assertions}
This list is current for PHPUnit 4.8.x.

\begin{verbatim}
assertArrayHasKey()
assertClassHasAttribute()
assertArraySubset()
assertClassHasStaticAttribute()
assertContains()
assertContainsOnly()
assertContainsOnlyInstancesOf()
assertCount()
assertEmpty()
assertEqualXMLStructure()
assertEquals()
assertFalse()
assertFileEquals()
assertFileExists()
assertGreaterThan()
assertGreaterThanOrEqual()
assertInstanceOf()
assertInternalType()
assertJsonFileEqualsJsonFile()
assertJsonStringEqualsJsonFile()
assertJsonStringEqualsJsonString()
assertLessThan()
assertLessThanOrEqual()
assertNull()
assertObjectHasAttribute()
assertRegExp()
assertStringMatchesFormat()
assertStringMatchesFormatFile()
assertSame()
assertStringEndsWith()
assertStringEqualsFile()
assertStringStartsWith()
assertThat()
assertTrue()
assertXmlFileEqualsXmlFile()
assertXmlStringEqualsXmlFile()
assertXmlStringEqualsXmlString()
\end{verbatim}

\end{document}
