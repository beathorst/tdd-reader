\documentclass[a4paper,10pt,headsepline]{scrartcl}
\include{packages}
\include{styles}

\usepackage[american]{babel}
\selectlanguage{american}

\hypersetup{
 pdfauthor={Oliver Klee, typo3-coding@oliverklee.de},
 pdftitle={Test-driven development with PHPUnit (with and without TYPO3)},
 pdfsubject={Handout for Oliver Klee's workshops on test-driven development with PHPUnit (with and without TYPO3).},
 pdfkeywords={TDD, unit testing, PHPUnit, workshop, seminar, PHP}
}

\author{
  Oliver Klee | \texttt{typo3-coding@oliverklee.de} | \texttt{@oliklee} \\
  \url{https://github.com/oliverklee/tdd-reader}
}

\date{Version 2.0.2, \today, for TYPO3 CMS 6.2}

\title{
  Cheatsheet for test-driven development\\with PHPUnit (with and without TYPO3)
}

\begin{document}

\maketitle

\section*{License}

This handout is licensed under a \emph{Creative Commons} license, in this case under an \emph{Attribution-ShareAlike~4.0 (CC BY-SA 4.0)}. This means that you can use, edit and distribute this handout (even commercially) under the following conditions:

\begin{description}
  \item[Attribution.] You need to give credit to the author (me) by listing my name (Oliver Klee). If you also list the source\footnote{\url{https://github.com/oliverklee/tdd-reader}}, that would be nice. And if you want to make me happy, please drop me an e-mail if you use this document.
  \item[ShareAlike.] If you edit or change this document or use it as a basis for some other document, you must use the same license for the resulting document.
  \item[Name the license.] If you distribute this document, you'll need to mention or enclose the license.
\end{description}

You can find a more comprehensive version of this license online.\footnote{\url{http://creativecommons.org/licenses/by-sa/4.0/}}


\pagebreak

\tableofcontents

\pagebreak

\section{File and class naming}

\subsection{File names}

\begin{tabular}{|l|l|}
  \hline
  \fett{Production code file name} & \fett{Test file name} \\
  \hline
  \texttt{Classes/Domain/Model/Shoe.php} & \texttt{Tests/Unit/Domain/Model/ShoeTest.php} \\
  \hline
  \texttt{Classes/Service/BaristaService.php} & \texttt{Tests/Unit/Service/BaristaServiceTest.php} \\
  \hline
\end{tabular}


\subsection{Class names}

\small
\begin{tabular}{|l|l|}
  \hline
  \fett{Production code class name} & \fett{Test class name} \\
  \hline
  \texttt{OliverKlee\textbackslash Shop\textbackslash Domain\textbackslash Model\textbackslash Shoe} & \texttt{OliverKlee\textbackslash Shop\textbackslash Tests\textbackslash Unit\textbackslash Domain\textbackslash Model\textbackslash ShoeTest} \\
  \hline
  \texttt{OliverKlee\textbackslash Shop\textbackslash Service\textbackslash BaristaService} & \texttt{OliverKlee\textbackslash Shop\textbackslash Tests\textbackslash Unit\textbackslash Service\textbackslash BaristaServiceTest} \\
  \hline
\end{tabular}
\normalsize


\pagebreak
\section{Test class structure}

\subsection{Extbase extensions}

There's an example project (the tea example) for this on GitHub:\\
\url{https://github.com/oliverklee/ext_tea}\\

\begin{phpcode}
namespace OliverKlee\Shop\Tests\Unit\Domain\Model;

use OliverKlee\Shop\Domain\Model\Article;

class ArticleTest extends \TYPO3\CMS\Core\Tests\UnitTestCase {
    /**
     * @var Article;
     */
    protected $subject = null;

    protected function setUp()
    {
        $this->subject = new Article;
        $this->subject->initializeObject();
    }

    /**
     * @test
     */
    public function getNameInitiallyReturnsEmptyString()
    {
        self::assertSame('', $this->subject->getName());
    }

    /**
     * @test
     */
    public function setNameSetsName()
    {
        $name = 'foo bar';

        $this->subject->setName($name);

        self::assertSame($name, $this->subject->getName());
    }

    // ...
}
\end{phpcode}

\subsection{Non-extbase extensions}

\begin{phpcode}
class AttachmentTest extends \Tx_Phpunit_TestCase {
    /**
     * @var \Tx_Oelib_Attachment
     */
    protected $subject = null;

    protected function setUp()
    {
        $this->subject = new \Tx_Oelib_Attachment();
    }

    /**
     * @test
     */
    public function getFileNameInitiallyReturnsAnEmptyString()
    {
        self::assertSame('', $this->subject->getFileName());
    }

    /**
     * @test
     */
    public function getFileNameWithFileNameSetReturnsFileName()
    {
        $fileName = 'test.txt';

        $this->subject->setFileName($fileName);

        self::assertSame($fileName, $this->subject->getFileName());
    }

    /**
     * @test
     * @expectedException \InvalidArgumentException
     */
    public function setFileNameWithEmptyFileNameThrowsException()
    {
        $this->subject->setFileName('');
    }

    // ...
}
\end{phpcode}

\subsection{Non-TYPO3 PHP projects with Composer}

There is an empty starter project for this on GitHub:\\
\url{https://github.com/oliverklee/tdd-seed}


\subsubsection{composer.json}

This setup installs PHPUnit and vfsStream \fett{for PHP up to 5.6}:\\

\begin{jsoncode}
{
    "require-dev": {
        "phpunit/phpunit": "^5.7.19",
        "mikey179/vfsStream": "^1.6.4"
    },
    "autoload": {
        "psr-4": {
            "..."
        }
    },
    "autoload-dev": {
        "psr-4": {
            "..."
        }
    }
}
\end{jsoncode}

This setup installs PHPUnit and vfsStream \fett{for PHP 6}:\\

\begin{jsoncode}
{
    "require-dev": {
        "phpunit/phpunit": "^6.0.13",
        "mikey179/vfsStream": "^1.6.4"
    },
    "autoload": {
        "psr-4": {
            "..."
        }
    },
    "autoload-dev": {
        "psr-4": {
            "..."
        }
    }
}
\end{jsoncode}

\subsubsection{Test case}
\begin{phpcode}
namespace OliverKlee\Books\Tests\Unit\Domain\Model;

use OliverKlee\Books\Domain\Model;

class BookTest extends \PHPUnit_Framework_TestCase {
    /**
     * @var Book
     */
    protected $subject = null;

    protected function setUp()
    {
        $this->subject = new Book();
    }

    /**
     * @test
     */
    public function getTitleInitiallyReturnsEmptyString()
    {
        self::assertSame('', $this->subject->getTitle());
    }

    /**
     * @test
     */
    public function setTitleSetsTitle()
    {
        $title = 'foo bar';

        $this->subject->setTitle($title);

        self::assertSame('foo bar', $this->subject->getTitle());
    }
}
\end{phpcode}


\pagebreak
\section{Testing for Exceptions}

\subsection{Test for the Exception class only}
\begin{phpcode}
/**
 * @test
 * @expectedException InvalidArgumentException
 */
public function createBreadWithNegativeSizeThrowsException()
{
    $this->subject->createBread(-1);
}
\end{phpcode}

\subsection{Test for the exception class, message and the code}
\begin{phpcode}
/**
 * @test
 * @expectedException \InvalidArgumentException
 * @expectedExceptionMessage size must be > 0.
 * @expectedExceptionCode 1323700434
 */
public function createBreadWithNegativeSizeThrowsException()
{
    $this->subject->createBread(-1);
}
\end{phpcode}


\pagebreak
\section{Testing abstract classes}

\subsection{Using the PHPUnit mock builder}

This will create an instance of the abstract class with all abstract methods mocked.\\

\begin{phpcode}
namespace OliverKlee\Coffee\Tests\Unit\Domain\Model;

use OliverKlee\Coffee\Domain\Model\AbstractBeverage;

class AbstractBeverageTest {
    /**
     * @var AbstractBeverage|\PHPUnit_Framework_MockObject_MockObject
     */
    protected $subject = null;

    protected function setUp()
    {
        $this->subject = $this->getMockForAbstractClass(
            AbstractBeverage::class
        );
    }
\end{phpcode}

\subsection{Creating a concrete subclass}
This is recommended if you need to provide your subclass with some additional or specific behavior.

In \texttt{Tests/Unit/Domain/Model/Fixtures/}, create a subclass of the abstract class:\\

\begin{phpcode}
namespace OliverKlee\Coffee\Tests\Unit\Domain\Model\Fixtures;

class TestingBeverage extends \OliverKlee\Coffee\Domain\Model\AbstractBeverage {
    // ...
}
\end{phpcode}

Then you can use and instantiate the concrete subclass in your unit tests:\\

\begin{phpcode}
use OliverKlee\Coffee\Tests\Unit\Domain\Model\Fixtures\TestingBeverage;

class AbstractBeverageTest {
    /**
     * @var TestingBeverage
     *
    protected $subject = null;

    protected function setUp()
    {
        $this->subject = new TestingBeverage();
    }
\end{phpcode}


\pagebreak
\section{Using the testing framework of the PHPUnit TYPO3 extension}

\begin{phpcode}
class DataMapperTest extends \Tx_Phpunit_TestCase {
    /**
     * @var \Tx_Phpunit_Framework
     */
    protected $testingFramework = null;

    protected $subject = null;

    protected function setUp()
    {
        $this->testingFramework = new \Tx_Phpunit_Framework('tx_oelib');

        $this->subject = new ...;
    }

    protected function tearDown()
    {
        $this->testingFramework->cleanUp();
    }

    /**
     * @test
     */
    public function findWithUidOfExistingRecordReturnsModelDataFromDatabase()
    {
        $title = 'foo';
        $uid = $this->testingFramework->createRecord(
            'tx_oelib_test', ['title' => $title]
        );

        self::assertSame($title, $this->subject->find($uid)->getTitle());
    }
\end{phpcode}

\subsection{Executable examples}

The functional tests for the FileUtility class in the tea example show what tests with vfsStream can look like.


\pagebreak
\section{Using mock file systems with vfsStream}
\subsection{Setting it all up}
\begin{phpcode}
use org\bovigo\vfs\vfsStream;
use org\bovigo\vfs\vfsStreamDirectory;

/**
 * @var \org\bovigo\vfs\vfsStreamFile
 */
protected $moreStuff;

protected function setUp()
{
    // This is the same as ::register and ::setRoot.
    $this->root = vfsStream::setup('home');
    $this->targetFilePath = vfsStream::url('home/target.txt');

    $this->subject = new ...
}
\end{phpcode}

\subsection{Using the files}
\small
\begin{phpcode}
/**
 * @test
 */
public function concatenateWithOneEmptySourceFileCreatesEmptyTargetFile()
{
    // This is one way to create a file with contents, using PHP's file functions.
    $sourceFileName = vfsStream::url('home/source.txt');
    // Just calling vfsStream::url does not create the file yet.
    // We need to write into it to create it.
    file_put_contents($sourceFileName, '');

    $this->subject->concatenate($this->targetFilePath, [$sourceFileName]);

    self::assertSame('', file_get_contents($this->targetFilePath));
}

/**
 * @test
 */
public function concatenateWithOneFileCopiesContentsFromSourceFileToTargetFile()
{
    // This is vfsStream's way of creating a file with contents.
    $contents = 'Hello world!';
    $sourceFileName = vfsStream::url('home/source.txt');
    vfsStream::newFile('source.txt')->at($this->root)->setContent($contents);

    $this->subject->concatenate($this->targetFilePath, [$sourceFileName]);

    self::assertSame($contents, file_get_contents($this->targetFilePath));
}
\end{phpcode}
\normalsize

\pagebreak
\section{PHPUnit assertions}
This list is current for PHPUnit 4.8.x.

\begin{verbatim}
assertArrayHasKey()
assertClassHasAttribute()
assertArraySubset()
assertClassHasStaticAttribute()
assertContains()
assertContainsOnly()
assertContainsOnlyInstancesOf()
assertCount()
assertEmpty()
assertEqualXMLStructure()
assertEquals()
assertFalse()
assertFileEquals()
assertFileExists()
assertGreaterThan()
assertGreaterThanOrEqual()
assertInstanceOf()
assertInternalType()
assertJsonFileEqualsJsonFile()
assertJsonStringEqualsJsonFile()
assertJsonStringEqualsJsonString()
assertLessThan()
assertLessThanOrEqual()
assertNull()
assertObjectHasAttribute()
assertRegExp()
assertStringMatchesFormat()
assertStringMatchesFormatFile()
assertSame()
assertStringEndsWith()
assertStringEqualsFile()
assertStringStartsWith()
assertThat()
assertTrue()
assertXmlFileEqualsXmlFile()
assertXmlStringEqualsXmlFile()
assertXmlStringEqualsXmlString()
\end{verbatim}

\end{document}
